{{- /* JSON search index for Lunr.js (fixed substring, safe heading cleanup) */ -}}
{{- $pages := slice -}}
{{- $sitePages := where .Site.RegularPages "Kind" "page" -}}
{{- $sitePages = where $sitePages ".Params.indexed" "ne" false -}}
{{- range $p := $sitePages -}}
  {{- $plain := $p.Plain | plainify -}}
  {{- $short := $plain -}}
  {{- if gt (len $plain) 500 -}}
    {{- $short = printf "%s" (substr $plain 0 500) -}}
  {{- end -}}

  {{- /* Build headings from ToC plain text */ -}}
  {{- $tocHTML := $p.TableOfContents | plainify -}}
  {{- $headings := slice $p.Title -}}
  {{- if $tocHTML -}}
    {{- range (split $tocHTML "\n") -}}
      {{- $line := . | replaceRE `^\s+|\s+$` "" -}}
      {{- if $line }}{{ $headings = $headings | append $line }}{{ end -}}
    {{- end -}}
  {{- end -}}

  {{- /* Deduplicate headings using a scratch map */ -}}
  {{- $scratch := newScratch -}}
  {{- $scratch.Set "seen" (dict) -}}
  {{- $unique := slice -}}
  {{- range $h := $headings -}}
    {{- $k := lower (replaceRE `^\s+|\s+$` "" $h) -}}
    {{- $seen := $scratch.Get "seen" -}}
    {{- if not (index $seen $k) -}}
      {{- $clean := $h | replace "\n" " " | replace "\r" " " | replace "\t" " " | replaceRE `^\s+|\s+$` "" -}}
      {{- $unique = $unique | append $clean -}}
      {{- $seen = merge $seen (dict $k true) -}}
      {{- $scratch.Set "seen" $seen -}}
    {{- end -}}
  {{- end -}}

  {{- $item := dict
      "title" $p.Title
      "description" (or $p.Params.description ($p.Summary | plainify))
      "summary" ($p.Summary | plainify)
      "tags" $p.Params.tags
      "categories" $p.Params.categories
      "date" ($p.Date.Format "2006-01-02")
      "permalink" $p.Permalink
      "content" $short
      "headings" $unique
  -}}
  {{- $pages = $pages | append $item -}}
{{- end -}}
{{- jsonify $pages -}}
