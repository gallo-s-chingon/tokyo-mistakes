{{/* saved as search-script.html in tokyo-mistakes/layouts/partials */}} {{ if
.Site.Params.search.enabled }}
<script>
  // Search functionality
  (function() {
    let searchIndex = [];
    let searchResults = document.getElementById('search-results');
    let searchInput = document.getElementById('search-input');

    // Load search index
    {{ $searchIndex := slice }}
    {{ range where .Site.RegularPages "Type" "in" (slice "blog" "podcast" "featured") }}
      {{ $searchItem := dict
        "title" .Title
        "permalink" .Permalink
        "summary" (.Summary | plainify | truncate 200)
        "content" (.Content | plainify | truncate 500)
        "date" (.Date.Format "Jan 2, 2006")
        "tags" .Params.tags
        "section" .Section
      }}
      {{ $searchIndex = $searchIndex | append $searchItem }}
    {{ end }}

    searchIndex = {{ $searchIndex | jsonify }};

    function performSearch(query) {
      if (!query || query.length < 2) {
        showNoResults();
        return;
      }

      const results = searchIndex.filter(item =>
        item.title.toLowerCase().includes(query.toLowerCase()) ||
        item.content.toLowerCase().includes(query.toLowerCase()) ||
        item.tags && item.tags.some(tag => tag.toLowerCase().includes(query.toLowerCase()))
      );

      displayResults(results, query);
    }

    function displayResults(results, query) {
      if (results.length === 0) {
        searchResults.innerHTML = `
          <div class="search-no-results">
            <i class="fas fa-search"></i>
            <p>No results for "${query}"</p>
          </div>
        `;
        return;
      }

      const resultsHTML = results.map(result => `
        <article class="search-result">
          <h3 class="search-result-title">
            <a href="${result.permalink}">${highlightMatches(result.title, query)}</a>
          </h3>
          <p class="search-result-summary">${highlightMatches(result.summary, query)}</p>
          <div class="search-result-meta">
            <span class="search-result-date">${result.date}</span>
            <span class="search-result-section">${result.section}</span>
            ${result.tags && result.tags.length > 0 ? `<span class="search-result-tags">${result.tags.map(tag => `#${tag}`).join(' ')}</span>` : ''}
          </div>
        </article>
      `).join('');

      searchResults.innerHTML = `
        <div class="search-results-header">
          <p>Found ${results.length} result${results.length === 1 ? '' : 's'} for "${query}"</p>
        </div>
        ${resultsHTML}
      `;
    }

    function highlightMatches(text, query) {
      if (!text) return '';
      const regex = new RegExp(`(${query})`, 'gi');
      return text.replace(regex, '<mark>$1</mark>');
    }

    function showNoResults() {
      searchResults.innerHTML = `
        <div class="search-no-results">
          <i class="fas fa-search"></i>
          <p>Start typing to search...</p>
        </div>
      `;
    }

    // Search input handler
    let searchTimeout;
    if (searchInput) {
      searchInput.addEventListener('input', function(e) {
        clearTimeout(searchTimeout);
        searchTimeout = setTimeout(() => {
          performSearch(e.target.value);
        }, 300);
      });
    }
  })();
</script>
{{ end }}
