{{/* saved as search-overlay.html in tokyo-mistakes/layouts/partials */}}
{{ if .Site.Params.search.enabled }}
<div id="search-overlay" class="search-overlay">
  <div class="search-container">
    <div class="search-header">
      <div class="search-input-wrapper">
        <i class="fas fa-search search-icon"></i>
        <input
          type="text"
          id="search-input"
          class="search-input"
          placeholder="Search posts..."
          autocomplete="off"
          aria-label="Search"
        />
      </div>
      <button id="search-close" class="search-close" aria-label="Close search">
        <i class="fas fa-times"></i>
      </button>
    </div>

    <div id="search-results" class="search-results">
      <div class="search-no-results">
        <i class="fas fa-search"></i>
        <p>Start typing to search...</p>
      </div>
    </div>
  </div>
</div>

<script>
  document.addEventListener('DOMContentLoaded', function() {
    const searchToggle = document.getElementById('search-toggle');
    const searchOverlay = document.getElementById('search-overlay');
    const searchInput = document.getElementById('search-input');
    const searchClose = document.getElementById('search-close');
    const searchResults = document.getElementById('search-results');
    
    if (!searchToggle || !searchOverlay || !searchInput || !searchClose || !searchResults) {
      console.error('Search elements missing');
      return;
    }
    
    // Open search overlay
    searchToggle.addEventListener('click', function() {
      console.log('Opening search overlay');
      searchOverlay.classList.add('active');
      document.body.classList.add('search-open');
      setTimeout(() => searchInput.focus(), 100);
    });
    
    // Close search overlay
    searchClose.addEventListener('click', function() {
      console.log('Closing search overlay');
      searchOverlay.classList.remove('active');
      document.body.classList.remove('search-open');
      searchInput.value = '';
      searchResults.innerHTML = `
        <div class="search-no-results">
          <i class="fas fa-search"></i>
          <p>Start typing to search...</p>
        </div>
      `;
    });
    
    // Handle escape key
    document.addEventListener('keydown', function(e) {
      if (e.key === 'Escape' && searchOverlay.classList.contains('active')) {
        searchClose.click();
      }
    });
    
    // Search functionality
    searchInput.addEventListener('input', function() {
      const query = this.value.trim().toLowerCase();
      
      if (!query) {
        searchResults.innerHTML = `
          <div class="search-no-results">
            <i class="fas fa-search"></i>
            <p>Start typing to search...</p>
          </div>
        `;
        return;
      }
      
      if (!window.searchIndex || !window.searchIndex.length) {
        searchResults.innerHTML = `
          <div class="search-no-results">
            <i class="fas fa-exclamation-triangle"></i>
            <p>Search index not available. Please try again later.</p>
          </div>
        `;
        return;
      }
      
      const results = window.searchIndex.filter(item => {
        const content = `${item.title} ${item.summary || ''} ${item.content || ''} ${(item.tags || []).join(' ')}`.toLowerCase();
        return content.includes(query);
      });
      
      if (results.length === 0) {
        searchResults.innerHTML = `
          <div class="search-no-results">
            <i class="fas fa-search"></i>
            <p>No results found for "${query}"</p>
          </div>
        `;
        return;
      }
      
      const html = results.slice(0, 10).map(item => `
        <div class="search-result">
          <h3 class="search-result-title">
            <a href="${item.permalink}">${item.title}</a>
          </h3>
          <p class="search-result-summary">${item.summary || ''}</p>
          <div class="search-result-meta">
            <span>${item.date || ''}</span>
            ${item.section ? `<span>${item.section}</span>` : ''}
          </div>
        </div>
      `).join('');
      
      searchResults.innerHTML = html;
    });
  });
</script>
{{ end }}
