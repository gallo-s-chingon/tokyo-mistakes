{{- define "title" }}{{ .Title }} - {{ .Site.Title }}{{ end -}}

{{- define "content" -}}
    {{- $params := .Scratch.Get "params" -}}

    {{- $toc := $params.toc -}}
    {{- if eq $toc true -}}
        {{- $toc = .Site.Params.page.toc | default dict -}}
    {{- else if eq $toc false -}}
        {{- $toc = dict "enable" false -}}
    {{- end -}}

    <article class="page single featured-appearance">
        {{- /* Title */ -}}
        <h1 class="single-title animate__animated animate__flipInX">{{ .Title | emojify }}</h1>

        {{- /* Check if metadata overlay is enabled */ -}}
        {{- $overlayEnabled := false -}}
        {{- if isset $params "overlaymetadata" -}}
            {{- $overlayEnabled = $params.overlaymetadata -}}
        {{- else if .Site.Params.podcast.overlay.enable -}}
            {{- $overlayEnabled = .Site.Params.podcast.overlay.enable -}}
        {{- end -}}

        {{- $overlayPosition := $params.overlayposition | default .Site.Params.podcast.overlay.position | default "lower-left" -}}
        {{- $overlayOpacity := .Site.Params.podcast.overlay.opacity | default 0.85 -}}

        {{- /* Featured image */ -}}
        {{- $image := $params.featuredImagePreview | default $params.featuredImage -}}
        {{- with .Resources.GetMatch "featured-image" -}}
            {{- $image = .RelPermalink -}}
        {{- end -}}

        {{- if and $image $overlayEnabled -}}
            {{- /* Featured Image with Metadata Overlay */ -}}
            {{- /* Color overlay filter (Jekyll MM style) */ -}}
            {{- $overlayFilter := $params.overlay_filter | default "" -}}
            {{- $overlayFilterCSS := partial "function/overlay-filter.html" $overlayFilter -}}
            <div class="featured-image-container featured-appearance-overlay" data-position="{{ $overlayPosition }}">
                <div class="featured-image appearance-artwork">
                    {{- dict "Src" $image "Title" $.Description "Resources" $.Resources | partial "plugin/img.html" -}}
                    {{- if $overlayFilterCSS -}}
                        <div class="featured-image-color-overlay" style="background: {{ $overlayFilterCSS | safeCSS }};"></div>
                    {{- end -}}
                </div>
                <div class="featured-metadata-overlay overlay-{{ $overlayPosition }}" style="--overlay-opacity: {{ $overlayOpacity }};">
                    <div class="overlay-content">
                        {{- /* Appearance Metadata in Overlay */ -}}
                        <div class="post-meta appearance-meta">
                            {{- $type := $params.type | default $params.appearancetype -}}
                            {{- with $type -}}
                                <div class="post-meta-line">
                                    <span class="appearance-type">
                                        <i class="fas fa-star fa-fw" aria-hidden="true"></i>&nbsp;{{ if reflect.IsSlice . }}{{ index . 0 | title }}{{ else }}{{ . | title }}{{ end }}
                                    </span>
                                </div>
                            {{- end -}}
                            {{- $podcastName := $params.podcastname | default $params.platform -}}
                            {{- with $podcastName -}}
                                <div class="post-meta-line">
                                    <span class="appearance-platform">
                                        <i class="fas fa-broadcast-tower fa-fw" aria-hidden="true"></i>&nbsp;{{ if reflect.IsSlice . }}{{ index . 0 }}{{ else }}{{ . }}{{ end }}
                                    </span>
                                </div>
                            {{- end -}}
                            {{- with .Site.Params.dateformat | default "2006-01-02" | .Date.Format -}}
                                <div class="post-meta-line">
                                    <span class="appearance-date">
                                        <i class="far fa-calendar-alt fa-fw" aria-hidden="true"></i>&nbsp;<time datetime="{{ . }}">{{ . }}</time>
                                    </span>
                                </div>
                            {{- end -}}
                            {{- with $params.hosts -}}
                                <div class="post-meta-line">
                                    <span class="appearance-hosts">
                                        <i class="fas fa-microphone fa-fw" aria-hidden="true"></i>&nbsp;Hosted by {{ delimit . ", " }}
                                    </span>
                                </div>
                            {{- end -}}
                            {{- $guests := $params.guests | default $params.coguests -}}
                            {{- with $guests -}}
                                <div class="post-meta-line">
                                    <span class="appearance-coguests">
                                        <i class="fas fa-users fa-fw" aria-hidden="true"></i>&nbsp;With {{ delimit . ", " }}
                                    </span>
                                </div>
                            {{- end -}}
                        </div>
                    </div>
                </div>
            </div>
        {{- else -}}
            {{- /* Standard Layout - Metadata Above Image */ -}}
            {{- /* Appearance Metadata */ -}}
            <div class="post-meta appearance-meta">
                {{- $type := $params.type | default $params.appearancetype -}}
                {{- with $type -}}
                    <div class="post-meta-line">
                        <span class="appearance-type">
                            <i class="fas fa-star fa-fw" aria-hidden="true"></i>&nbsp;{{ if reflect.IsSlice . }}{{ index . 0 | title }}{{ else }}{{ . | title }}{{ end }}
                        </span>
                    </div>
                {{- end -}}
                {{- $podcastName := $params.podcastname | default $params.platform -}}
                {{- with $podcastName -}}
                    <div class="post-meta-line">
                        <span class="appearance-platform">
                            <i class="fas fa-broadcast-tower fa-fw" aria-hidden="true"></i>&nbsp;{{ if reflect.IsSlice . }}{{ index . 0 }}{{ else }}{{ . }}{{ end }}
                        </span>
                    </div>
                {{- end -}}
                {{- with .Site.Params.dateformat | default "2006-01-02" | .Date.Format -}}
                    <div class="post-meta-line">
                        <span class="appearance-date">
                            <i class="far fa-calendar-alt fa-fw" aria-hidden="true"></i>&nbsp;<time datetime="{{ . }}">{{ . }}</time>
                        </span>
                    </div>
                {{- end -}}
                {{- with $params.hosts -}}
                    <div class="post-meta-line">
                        <span class="appearance-hosts">
                            <i class="fas fa-microphone fa-fw" aria-hidden="true"></i>&nbsp;Hosted by {{ delimit . ", " }}
                        </span>
                    </div>
                {{- end -}}
                {{- $guests := $params.guests | default $params.coguests -}}
                {{- with $guests -}}
                    <div class="post-meta-line">
                        <span class="appearance-coguests">
                            <i class="fas fa-users fa-fw" aria-hidden="true"></i>&nbsp;With {{ delimit . ", " }}
                        </span>
                    </div>
                {{- end -}}
            </div>

            {{- with $image -}}
                {{- /* Color overlay filter (Jekyll MM style) */ -}}
                {{- $overlayFilter := $params.overlay_filter | default "" -}}
                {{- $overlayFilterCSS := partial "function/overlay-filter.html" $overlayFilter -}}
                <div class="featured-image appearance-artwork" style="position: relative;">
                    {{- dict "Src" . "Title" $.Description "Resources" $.Resources | partial "plugin/img.html" -}}
                    {{- if $overlayFilterCSS -}}
                        <div class="featured-image-color-overlay" style="background: {{ $overlayFilterCSS | safeCSS }};"></div>
                    {{- end -}}
                </div>
            {{- end -}}
        {{- end -}}

        {{- /* Auto TOC */ -}}
        {{- if ne $toc.enable false -}}
            <div class="toc" id="toc-auto">
                <h2 class="toc-title">{{ T "contents" }}</h2>
                <div class="toc-content{{ if eq $toc.auto false }} always-active{{ end }}" id="toc-content-auto"></div>
            </div>
        {{- end -}}

        {{- /* Static TOC */ -}}
        {{- if ne $toc.enable false -}}
            <div class="details toc" id="toc-static"  data-kept="{{ if $toc.keepStatic }}true{{ end }}">
                <div class="details-summary toc-title">
                    <span>{{ T "contents" }}</span>
                    <span><i class="details-icon fas fa-angle-right" aria-hidden="true"></i></span>
                </div>
                <div class="details-content toc-content" id="toc-content-static">
                    {{- dict "Content" .TableOfContents "Ruby" $params.ruby "Fraction" $params.fraction "Fontawesome" $params.fontawesome | partial "function/content.html" | safeHTML -}}
                </div>
            </div>
        {{- end -}}

        {{- /* External Link CTA */ -}}
        {{- with $params.externalurl -}}
            <div class="appearance-cta" style="margin-bottom: 50px;">
                <a href="{{ . }}" class="button primary" target="_blank" rel="noopener noreferrer">
                    <i class="fas fa-external-link-alt fa-fw" aria-hidden="true"></i>&nbsp;
                    {{- $podcastName := $params.podcastname | default $params.platform -}}
                    {{- if $podcastName -}}
                        Listen on {{ $podcastName }}
                    {{- else -}}
                        View Appearance
                    {{- end -}}
                </a>
            </div>
        {{- end -}}

        {{- /* Embed (if available) */ -}}
        {{- with $params.embedurl -}}
            <div class="appearance-embed">
                {{- /* TODO: Smart embed handling in Sprint 4 */ -}}
                <div class="embed-placeholder">
                    <p><strong>Embedded Player:</strong> (Coming in Sprint 4)</p>
                    <p><code>{{ . }}</code></p>
                </div>
            </div>
        {{- end -}}

        {{- /* Content */ -}}
        <div class="content appearance-content" id="content">
            {{- dict "Content" .Content "Ruby" $params.ruby "Fraction" $params.fraction "Fontawesome" $params.fontawesome | partial "function/content.html" | safeHTML -}}
        </div>

        {{- /* Topics/Tags */ -}}
        {{- $showTopics := $params.topicson | default .Site.Params.topicsDiscussed -}}
        {{- if $showTopics -}}
            {{- $topics := $params.topics | default $params.tags -}}
            {{- with $topics -}}
                <div class="appearance-topics">
                    <h3>Topics Discussed</h3>
                    <ul class="topics-list">
                        {{- range . -}}
                            <li>{{ . }}</li>
                        {{- end -}}
                    </ul>
                </div>
            {{- end -}}
        {{- end -}}

        {{- /* Detect YouTube content for video-specific sharing */ -}}
        {{- $isVideo := false -}}
        {{- /* Check 1: podcast-youtube shortcode in content */ -}}
        {{- if findRE "podcast-youtube" .Content -}}
            {{- $isVideo = true -}}
        {{- end -}}
        {{- /* Check 2: embedPlayers with type:"youtube" */ -}}
        {{- if not $isVideo -}}
            {{- range $params.embedPlayers -}}
                {{- if eq .type "youtube" -}}
                    {{- $isVideo = true -}}
                {{- end -}}
            {{- end -}}
        {{- end -}}
        {{- /* Check 3: externalUrl containing youtube.com or youtu.be */ -}}
        {{- if not $isVideo -}}
            {{- with $params.externalurl -}}
                {{- if or (findRE "youtube\\.com" .) (findRE "youtu\\.be" .) -}}
                    {{- $isVideo = true -}}
                {{- end -}}
            {{- end -}}
        {{- end -}}
        {{- .Scratch.Set "isVideo" $isVideo -}}

        {{- /* Footer */ -}}
        {{- partial "single/footer.html" . -}}

        {{- /* Comment */ -}}
        {{- partial "comment.html" . -}}
    </article>
{{- end -}}
