{{- define "title" }}{{ .Title }} - {{ .Site.Title }}{{ end -}}

{{- define "content" -}}
    {{- $params := .Scratch.Get "params" -}}

    {{- $toc := $params.toc -}}
    {{- if eq $toc true -}}
        {{- $toc = .Site.Params.page.toc | default dict -}}
    {{- else if eq $toc false -}}
        {{- $toc = dict "enable" false -}}
    {{- end -}}

    {{- /* Auto TOC */ -}}
    {{- if ne $toc.enable false -}}
        <div class="toc" id="toc-auto">
            <h2 class="toc-title">{{ T "contents" }}</h2>
            <div class="toc-content{{ if eq $toc.auto false }} always-active{{ end }}" id="toc-content-auto"></div>
        </div>
    {{- end -}}

    <article class="page single episode">
        {{- /* Episode Title */ -}}
        <h1 class="single-title animate__animated animate__flipInX">{{ .Title | emojify }}</h1>

        {{- /* Check if metadata overlay is enabled */ -}}
        {{- $overlayEnabled := false -}}
        {{- if isset $params "overlaymetadata" -}}
            {{- $overlayEnabled = $params.overlaymetadata -}}
        {{- else if .Site.Params.podcast.overlay.enable -}}
            {{- $overlayEnabled = .Site.Params.podcast.overlay.enable -}}
        {{- end -}}

        {{- $overlayPosition := $params.overlayposition | default .Site.Params.podcast.overlay.position | default "lower-left" -}}
        {{- $overlayOpacity := .Site.Params.podcast.overlay.opacity | default 0.85 -}}

        {{- /* Featured image */ -}}
        {{- $image := $params.featuredImagePreview | default $params.featuredImage -}}
        {{- with .Resources.GetMatch "featured-image" -}}
            {{- $image = .RelPermalink -}}
        {{- end -}}

        {{- if and $image $overlayEnabled -}}
            {{- /* Featured Image with Metadata Overlay */ -}}
            {{- /* Color overlay filter (Jekyll MM style) */ -}}
            {{- $overlayFilter := $params.overlay_filter | default "" -}}
            {{- $overlayFilterCSS := partial "function/overlay-filter.html" $overlayFilter -}}
            <div class="featured-image-container episode-featured-overlay" data-position="{{ $overlayPosition }}">
                <div class="featured-image episode-artwork">
                    {{- dict "Src" $image "Title" $.Description "Resources" $.Resources | partial "plugin/img.html" -}}
                    {{- if $overlayFilterCSS -}}
                        <div class="featured-image-color-overlay" style="background: {{ $overlayFilterCSS }};"></div>
                    {{- end -}}
                </div>
                <div class="featured-metadata-overlay overlay-{{ $overlayPosition }}" style="--overlay-opacity: {{ $overlayOpacity }};">
                    <div class="overlay-content">
                        {{- /* Episode Metadata in Overlay */ -}}
                        <div class="post-meta episode-meta">
                            <div class="post-meta-line">
                                {{- with $params.episodenumber -}}
                                    <span class="episode-number">
                                        <i class="fas fa-hashtag fa-fw" aria-hidden="true"></i>&nbsp;Episode {{ . }}
                                    </span>&nbsp;
                                {{- end -}}
                                {{- with $params.season -}}
                                    <span class="episode-season">
                                        <i class="fas fa-layer-group fa-fw" aria-hidden="true"></i>&nbsp;Season {{ . }}
                                    </span>&nbsp;
                                {{- end -}}
                                {{- with $params.duration -}}
                                    <span class="episode-duration">
                                        <i class="far fa-clock fa-fw" aria-hidden="true"></i>&nbsp;{{ . }}
                                    </span>
                                {{- end -}}
                            </div>
                            <div class="post-meta-line">
                                {{- if $params.created -}}
                                    {{- $dateStr := substr $params.created 0 10 -}}
                                    {{- $date := time.AsTime $dateStr -}}
                                    {{- $dateFormat := .Site.Params.dateformat | default "2006-01-02" -}}
                                    <span class="episode-date">
                                        <i class="far fa-calendar-alt fa-fw" aria-hidden="true"></i>&nbsp;<time datetime="{{ $dateStr }}">{{ $date.Format $dateFormat }}</time>
                                    </span>
                                {{- else -}}
                                    {{- with .Site.Params.dateformat | default "2006-01-02" | .PublishDate.Format -}}
                                        <span class="episode-date">
                                            <i class="far fa-calendar-alt fa-fw" aria-hidden="true"></i>&nbsp;<time datetime="{{ . }}">{{ . }}</time>
                                        </span>
                                    {{- end -}}
                                {{- end -}}
                            </div>
                            <div class="post-meta-line">
                                {{- $podcast := $params.podcast | default .Site.Params.podcast.name -}}
                                {{- with $podcast -}}
                                    <span class="podcast-name">
                                        <i class="fas fa-podcast fa-fw" aria-hidden="true"></i>&nbsp;{{ . }}
                                    </span>&nbsp;
                                {{- end -}}
                                {{- $host := $params.host | default .Site.Params.podcast.hostName -}}
                                {{- with $host -}}
                                    <span class="episode-host">
                                        <i class="fas fa-microphone fa-fw" aria-hidden="true"></i>&nbsp;{{ . }}
                                    </span>&nbsp;
                                {{- end -}}
                                {{- with $params.guests -}}
                                    <span class="episode-guests">
                                        <i class="fas fa-users fa-fw" aria-hidden="true"></i>&nbsp;{{ delimit . ", " }}
                                    </span>
                                {{- end -}}
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        {{- else -}}
            {{- /* Standard Layout - Metadata Above Image */ -}}
            {{- /* Episode Metadata */ -}}
            <div class="post-meta episode-meta">
                <div class="post-meta-line">
                    {{- with $params.episodenumber -}}
                        <span class="episode-number">
                            <i class="fas fa-hashtag fa-fw" aria-hidden="true"></i>&nbsp;Episode {{ . }}
                        </span>&nbsp;
                    {{- end -}}
                    {{- with $params.season -}}
                        <span class="episode-season">
                            <i class="fas fa-layer-group fa-fw" aria-hidden="true"></i>&nbsp;Season {{ . }}
                        </span>&nbsp;
                    {{- end -}}
                    {{- with $params.duration -}}
                        <span class="episode-duration">
                            <i class="far fa-clock fa-fw" aria-hidden="true"></i>&nbsp;{{ . }}
                        </span>
                    {{- end -}}
                </div>
                <div class="post-meta-line">
                    {{- if $params.created -}}
                        {{- $dateStr := substr $params.created 0 10 -}}
                        {{- $date := time.AsTime $dateStr -}}
                        {{- $dateFormat := .Site.Params.dateformat | default "2006-01-02" -}}
                        <span class="episode-date">
                            <i class="far fa-calendar-alt fa-fw" aria-hidden="true"></i>&nbsp;<time datetime="{{ $dateStr }}">{{ $date.Format $dateFormat }}</time>
                        </span>
                    {{- else -}}
                        {{- with .Site.Params.dateformat | default "2006-01-02" | .PublishDate.Format -}}
                            <span class="episode-date">
                                <i class="far fa-calendar-alt fa-fw" aria-hidden="true"></i>&nbsp;<time datetime="{{ . }}">{{ . }}</time>
                            </span>
                        {{- end -}}
                    {{- end -}}
                </div>
                <div class="post-meta-line">
                    {{- $podcast := $params.podcast | default .Site.Params.podcast.name -}}
                    {{- with $podcast -}}
                        <span class="podcast-name">
                            <i class="fas fa-podcast fa-fw" aria-hidden="true"></i>&nbsp;{{ . }}
                        </span>&nbsp;
                    {{- end -}}
                    {{- $host := $params.host | default .Site.Params.podcast.hostName -}}
                    {{- with $host -}}
                        <span class="episode-host">
                            <i class="fas fa-microphone fa-fw" aria-hidden="true"></i>&nbsp;{{ . }}
                        </span>&nbsp;
                    {{- end -}}
                    {{- with $params.guests -}}
                        <span class="episode-guests">
                            <i class="fas fa-users fa-fw" aria-hidden="true"></i>&nbsp;{{ delimit . ", " }}
                        </span>
                    {{- end -}}
                </div>
            </div>

            {{- with $image -}}
                {{- /* Color overlay filter (Jekyll MM style) */ -}}
                {{- $overlayFilter := $params.overlay_filter | default "" -}}
                {{- $overlayFilterCSS := partial "function/overlay-filter.html" $overlayFilter -}}
                <div class="featured-image episode-artwork" style="position: relative;">
                    {{- dict "Src" . "Title" $.Description "Resources" $.Resources | partial "plugin/img.html" -}}
                    {{- if $overlayFilterCSS -}}
                        <div class="featured-image-color-overlay" style="background: {{ $overlayFilterCSS }};"></div>
                    {{- end -}}
                </div>
            {{- end -}}
        {{- end -}}

        {{- /* Podcast Player Stack */ -}}
        {{- partial "podcast/player-stack.html" . -}}

        {{- /* Static TOC */ -}}
        {{- if ne $toc.enable false -}}
            <div class="details toc" id="toc-static"  data-kept="{{ if $toc.keepStatic }}true{{ end }}">
                <div class="details-summary toc-title">
                    <span>{{ T "contents" }}</span>
                    <span><i class="details-icon fas fa-angle-right" aria-hidden="true"></i></span>
                </div>
                <div class="details-content toc-content" id="toc-content-static">
                    {{- dict "Content" .TableOfContents "Ruby" $params.ruby "Fraction" $params.fraction "Fontawesome" $params.fontawesome | partial "function/content.html" | safeHTML -}}
                </div>
            </div>
        {{- end -}}

        {{- /* Episode Content (Show Notes, Transcript, etc.) */ -}}
        <div class="content episode-content" id="content">
            {{- dict "Content" .Content "Ruby" $params.ruby "Fraction" $params.fraction "Fontawesome" $params.fontawesome | partial "function/content.html" | safeHTML -}}
        </div>

        {{- /* Subscribe Section */ -}}
        {{- partial "podcast/subscribe-buttons.html" . -}}

        {{- /* Detect YouTube content for video-specific sharing */ -}}
        {{- $isVideo := false -}}
        {{- /* Check 1: podcast-youtube shortcode in content */ -}}
        {{- if findRE "podcast-youtube" .Content -}}
            {{- $isVideo = true -}}
        {{- end -}}
        {{- /* Check 2: embedPlayers with type:"youtube" */ -}}
        {{- if not $isVideo -}}
            {{- range $params.embedPlayers -}}
                {{- if eq .type "youtube" -}}
                    {{- $isVideo = true -}}
                {{- end -}}
            {{- end -}}
        {{- end -}}
        {{- /* Check 3: externalUrl containing youtube.com or youtu.be */ -}}
        {{- if not $isVideo -}}
            {{- with $params.externalurl -}}
                {{- if or (findRE "youtube\\.com" .) (findRE "youtu\\.be" .) -}}
                    {{- $isVideo = true -}}
                {{- end -}}
            {{- end -}}
        {{- end -}}
        {{- .Scratch.Set "isVideo" $isVideo -}}

        {{- /* Footer */ -}}
        {{- partial "single/footer.html" . -}}

        {{- /* Comment */ -}}
        {{- partial "comment.html" . -}}
    </article>
{{- end -}}
